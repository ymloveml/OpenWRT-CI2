# 云编译公用核心 - 测试版本
# 用于测试编译流程的简化版核心配置文件
name: WRT-CORE-TEST

# 触发方式 - 工作流调用模式
on:
  workflow_call:  # 允许被其他工作流调用
    inputs:
      # 必需输入参数
      WRT_CONFIG:  # 编译配置名称
        required: true
        type: string
      WRT_THEME:  # 默认主题
        required: true
        type: string
      WRT_NAME:  # 默认主机名
        required: true
        type: string
      WRT_SSID:  # 默认WIFI名称
        required: true
        type: string
      WRT_WORD:  # 默认WIFI密码
        required: true
        type: string
      WRT_IP:  # 默认管理IP地址
        required: true
        type: string
      WRT_PW:  # 默认密码提示
        required: true
        type: string
      WRT_REPO:  # 源码仓库链接
        required: true
        type: string
      WRT_BRANCH:  # 源码分支
        required: true
        type: string
      # 可选输入参数
      WRT_SOURCE:  # 源码名称
        required: false
        type: string
      WRT_PACKAGE:  # 插件调整
        required: false
        type: string
      WRT_TEST:  # 是否仅测试配置
        required: false
        type: string
      CI_NAME:  # CI工作流名称
        required: false
        type: string
      WRT_ARCH:  # 架构信息
        required: false
        type: string

# 环境变量设置 - 将输入参数转换为环境变量供后续步骤使用
env:
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}  # GitHub令牌用于API访问
  WRT_CONFIG: ${{inputs.WRT_CONFIG}}  # 编译配置名称
  WRT_THEME: ${{inputs.WRT_THEME}}  # 默认主题
  WRT_NAME: ${{inputs.WRT_NAME}}  # 默认主机名
  WRT_SSID: ${{inputs.WRT_SSID}}  # 默认WIFI名称
  WRT_WORD: ${{inputs.WRT_WORD}}  # 默认WIFI密码
  WRT_IP: ${{inputs.WRT_IP}}  # 默认管理IP地址
  WRT_PW: ${{inputs.WRT_PW}}  # 默认密码提示
  WRT_REPO: ${{inputs.WRT_REPO}}  # 源码仓库链接
  WRT_BRANCH: ${{inputs.WRT_BRANCH}}  # 源码分支
  WRT_PACKAGE: ${{inputs.WRT_PACKAGE}}  # 插件调整
  WRT_TEST: ${{inputs.WRT_TEST}}  # 是否仅测试配置
  WRT_DIR: 'wrt'  # 源码目录
  CI_NAME: ${{inputs.CI_NAME}}  # CI工作流名称
  WRT_ARCH: ${{inputs.WRT_ARCH}}  # 架构信息

# 作业定义
jobs:
  core:  # 核心作业
    name: ${{inputs.WRT_SOURCE}}  # 作业名称使用源码名称
    runs-on: ubuntu-22.04  # 在Ubuntu 22.04环境运行
    steps:
      # 步骤1: 检出项目代码
      - name: Checkout Projects
        uses: actions/checkout@main  # 使用GitHub的checkout动作获取仓库代码

      # 步骤2: 初始化环境变量值
      - name: Initialization Values
        run: |
          # 设置编译日期时间（北京时间）
          echo "WRT_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          # 设置仓库标记（用户名）
          echo "WRT_MARK=$(echo $GITHUB_REPOSITORY | cut -d '/' -f 1)" >> $GITHUB_ENV
          # 设置版本信息（源码仓库名称-分支）
          echo "WRT_VER=$(echo $WRT_REPO | cut -d '/' -f 4)-$WRT_BRANCH" >> $GITHUB_ENV
          # 从配置文件中提取目标平台信息并转换为大写
          echo "WRT_TARGET=$(grep -m 1 -oP '^CONFIG_TARGET_\K[\w]+(?=\=y)' ./Config/$WRT_CONFIG.txt | tr '[:lower:]' '[:upper:]')" >> $GITHUB_ENV
          # 设置内核版本默认值
          echo "WRT_KVER=none" >> $GITHUB_ENV
          # 设置软件包列表默认值
          echo "WRT_LIST=none" >> $GITHUB_ENV

          # 设置CI环境变量
          echo "WRT_CI=$WRT_CI" >> $GITHUB_ENV
          # 如果未指定架构信息，则从配置文件中提取
          [[ -z $WRT_ARCH ]] && {
            export WRT_ARCH=$(sed -n 's/.*_DEVICE_\(.*\)_DEVICE_.*/\1/p' $GITHUB_WORKSPACE/Config/$WRT_CONFIG.txt | head -n 1)
            echo "WRT_ARCH=$WRT_ARCH" >> $GITHUB_ENV
          }
          # 创建仓库标记文件
          echo "$WRT_REPO/$WRT_BRANCH" > "$GITHUB_WORKSPACE/repo_flag"

      # 步骤3: 克隆源码
      - name: Clone Code
        run: |
          # 使用深度1克隆指定分支的源码到wrt目录
          git clone --depth=1 --single-branch --branch $WRT_BRANCH $WRT_REPO ./wrt/

          # 进入源码目录并获取最新提交的哈希值
          cd ./wrt/ && echo "WRT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV

      # 步骤4: 自定义设置
      - name: Custom Settings
        run: |
          # 加载函数库
          . $GITHUB_WORKSPACE/Scripts/function.sh
          # 进入源码目录
          cd ./wrt/    
          # 生成配置文件并显示
          generate_config && cat .config
     
